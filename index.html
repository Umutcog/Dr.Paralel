<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>NEBULA: AGENT vs HACKER</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        :root { --win-blue: #008080; --win-gray: #c0c0c0; }
        body { margin: 0; background-color: var(--win-blue); font-family: 'Tahoma', sans-serif; overflow: hidden; }
        #login-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--win-blue); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .win-dialog { background: var(--win-gray); border: 2px outset white; width: 340px; padding: 15px; box-shadow: 8px 8px 0 black; text-align: center; }
        #desktop { display: none; width: 100vw; height: 100vh; }
        .window { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; max-width: 650px; background: var(--win-gray); border: 2px outset white; }
        .win-title { background: navy; color: white; padding: 4px; font-weight: bold; font-size: 13px; text-align: left; }
        .win-body { padding: 10px; background: white; border: 2px inset var(--win-gray); margin: 4px; font-family: 'VT323'; min-height: 300px; }
        .btn-win { background: var(--win-gray); border: 2px outset white; padding: 10px; cursor: pointer; font-family: 'VT323'; font-size: 18px; width: 100%; margin-top: 5px; }
        .btn-win:active { border-style: inset; }
        .dist-track { height: 12px; background: #222; border: 1px solid #0f0; position: relative; margin: 15px 0; }
        #icon-player { position: absolute; left: 0; top: -10px; transition: 1s ease; font-size: 22px; }
        #icon-dr { position: absolute; left: 50%; top: -10px; transition: 1s ease; font-size: 22px; }
        input { width: 90%; padding: 8px; margin: 10px 0; border: 2px inset white; font-family: 'VT323'; font-size: 22px; text-align: center; text-transform: uppercase; }
        #status-light { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: red; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="win-dialog">
            <div style="background:navy; color:white; padding:2px; font-weight:bold; margin-bottom:10px; text-align:left;">OPERASYON_BAGLANTI_PANELI</div>
            <div id="my-id-display" style="font-family: 'VT323'; font-size: 24px; color: blue; border: 1px inset white; background: #eee; padding: 5px;">...</div>
            <p style="font-size: 12px; margin: 10px 0;">Yukarƒ±daki kodu rakibine ver veya rakibinin kodunu a≈üaƒüƒ±ya yaz:</p>
            <input type="text" id="target-id" placeholder="4 HANELI KOD">
            <button class="btn-win" onclick="connectToPeer()">BAGLANTIYI BASLAT</button>
            <div id="connection-status" style="font-size: 11px; margin-top: 10px; color: #444;">
                <span id="status-light"></span> <span id="status-text">Sinyal Aranƒ±yor</span>
            </div>
        </div>
    </div>

    <div id="desktop">
        <div class="window">
            <div class="win-title" id="role-label">NEBULA TERMINAL</div>
            <div class="win-body">
                <div style="background:black; color:#0f0; padding:8px; border:2px inset white;">
                    <div id="turn-info">VERƒ∞ AKI≈ûI ANALƒ∞Z EDƒ∞Lƒ∞YOR...</div>
                    <div class="dist-track"><div id="icon-player">üïµÔ∏è</div><div id="icon-dr">üòà</div></div>
                </div>
                <div id="game-area" style="color:black; margin-top:10px;">
                    <h2 id="q-text" style="font-size:24px;">Y√ºkleniyor...</h2>
                    <div id="options-area"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    let peer, conn;
    let myRole = ''; 
    let distance = 50; 
    let currentTaskIdx = 0;

    const tasks = [
        { q: "Hava olaylarƒ±nƒ±n anlƒ±k durumu?", opts: ["HAVA DURUMU", "ƒ∞KLƒ∞M"], ans: 0 },
        { q: "Ozon tabakasƒ± hangi katmandadƒ±r?", opts: ["STRATOSFER", "TROPOSFER"], ans: 0 },
        { q: "Kutup ƒ±≈üƒ±klarƒ±nƒ±n g√∂r√ºld√ºƒü√º katman?", opts: ["TERMOSFER", "MEZOSFER"], ans: 0 }
    ];

    // 4 HANELƒ∞ KISA KOD √úRETƒ∞Cƒ∞
    const shortId = Math.random().toString(36).substr(2, 4).toUpperCase();

    peer = new Peer(shortId, {
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' }
            ]
        }
    });

    peer.on('open', (id) => {
        document.getElementById('my-id-display').innerText = "KODUNUZ: " + id;
        document.getElementById('status-light').style.background = "orange";
        document.getElementById('status-text').innerText = "Sinyal Hazƒ±r";
    });

    peer.on('connection', (c) => {
        conn = c;
        myRole = 'ajan';
        setupEvents();
    });

    function connectToPeer() {
        const tid = document.getElementById('target-id').value.trim().toUpperCase();
        if(!tid) return alert("Kod gerekli!");
        conn = peer.connect(tid, { reliable: true });
        myRole = 'hirsiz';
        setupEvents();
    }

    function setupEvents() {
        conn.on('open', () => {
            document.getElementById('status-light').style.background = "lime";
            document.getElementById('status-text').innerText = "Baƒülƒ±";
            setTimeout(() => {
                conn.send({ type: 'FORCE_START', d: distance, idx: currentTaskIdx });
                initGame();
            }, 500);
        });

        conn.on('data', (data) => {
            if(data.type === 'FORCE_START' || data.type === 'MOVE') {
                distance = data.d;
                currentTaskIdx = data.idx;
                if(document.getElementById('desktop').style.display === 'none') initGame();
                render();
            }
        });
    }

    function initGame() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('desktop').style.display = 'block';
        document.getElementById('role-label').innerText = "OPERASYON: " + myRole.toUpperCase();
        render();
    }

    function render() {
        document.getElementById('icon-dr').style.left = distance + "%";
        const area = document.getElementById('options-area');
        area.innerHTML = '';
        const task = tasks[currentTaskIdx % tasks.length];
        const isMyTurn = (myRole === 'hirsiz' && currentTaskIdx % 2 === 0) || (myRole === 'ajan' && currentTaskIdx % 2 !== 0);

        if (isMyTurn) {
            document.getElementById('turn-info').innerText = "SIRA SENDE!";
            document.getElementById('q-text').innerText = task.q;
            task.opts.forEach((opt, i) => {
                const b = document.createElement('button');
                b.className = 'btn-win';
                b.innerText = opt;
                b.onclick = () => {
                    if(myRole === 'hirsiz') distance += (i === task.ans ? 10 : -5);
                    else distance -= (i === task.ans ? 12 : -7);
                    currentTaskIdx++;
                    conn.send({ type: 'MOVE', d: distance, idx: currentTaskIdx });
                    render();
                };
                area.appendChild(b);
            });
        } else {
            document.getElementById('turn-info').innerText = "RAKƒ∞P BEKLENƒ∞YOR...";
            document.getElementById('q-text').innerText = "Kar≈üƒ± tarafƒ±n hamlesi bekleniyor...";
        }
    }
</script>
</body>
</html>
