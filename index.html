<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Dr. Paralel - Siber Takip Modu</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
</head>
<body>

    <div id="game-container">
        <h2 id="nebula-status">>> NEBULA: SİBER_TAKİP_MODU</h2>
        <input type="text" id="room-code" placeholder="ODA KODUNU GİRİN (Örn: ENKA)">
        <button onclick="joinRoom()">SİSTEME_SIZ_>></button>
        <p id="status-message"></p>
    </div>

    <script>
        // 1. Firebase Yapılandırması (Kısıtladığın API Key Buraya)
        const firebaseConfig = {
            apiKey: "AIzaSyDYdIVHhh9HHjJAoaOKot8YbBQukgRKDC8",
            authDomain: "drparalel-1f0cd.firebaseapp.com",
            databaseURL: "https://drparalel-1f0cd-default-rtdb.firebaseio.com",
            projectId: "drparalel-1f0cd",
            storageBucket: "drparalel-1f0cd.appspot.com",
            messagingSenderId: "956382101031",
            appId: "1:956382101031:web:4624647343718447839366"
        };

        // Firebase Başlat
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        function joinRoom() {
            const roomID = document.getElementById('room-code').value.toUpperCase();
            const statusMsg = document.getElementById('status-message');

            if (!roomID) {
                alert("Lütfen bir oda kodu girin!");
                return;
            }

            const roomRef = database.ref('rooms/' + roomID);

            // Odayı ve içindeki oyuncuları kontrol et
            roomRef.once('value', (snapshot) => {
                const roomData = snapshot.val();
                let playerKey = "";

                if (!roomData || !roomData.p1) {
                    playerKey = "p1"; // Oda boşsa p1 ol
                } else if (!roomData.p2) {
                    playerKey = "p2"; // p1 doluysa p2 ol
                } else {
                    statusMsg.innerText = "ERİŞİM ENGELLENDİ: ODA DOLU!";
                    statusMsg.style.color = "red";
                    return;
                }

                // --- KRİTİK NOKTA: onDisconnect ---
                // Bu kod, bağlantı koptuğunda odayı otomatik temizler
                const myRef = database.ref('rooms/' + roomID + '/' + playerKey);
                
                // 1. Oyuncuyu odaya ekle
                myRef.set(true);

                // 2. Bağlantı koparsa (sekme kapanırsa) otomatik SİL
                myRef.onDisconnect().remove();

                statusMsg.innerText = "BAĞLANTI BAŞARILI. Sızılıyor...";
                statusMsg.style.color = "green";

                // Burada oyunun ana fonksiyonuna (startMatch gibi) geçiş yapabilirsin
                console.log(roomID + " odasına " + playerKey + " olarak girildi.");
            });
        }
    </script>
</body>
</html>
