<script>
    // ... (Firebase Config ve Tasks bölümleri aynı kalıyor) ...
    const firebaseConfig = {
        apiKey: "AIzaSyDYdIVHhh9HHjJAoaOKot8YbBQukgRKDC8",
        authDomain: "drparalel-1f0cd.firebaseapp.com",
        databaseURL: "https://drparalel-1f0cd-default-rtdb.firebaseio.com",
        projectId: "drparalel-1f0cd",
        storageBucket: "drparalel-1f0cd.firebasestorage.app",
        messagingSenderId: "464154880090",
        appId: "1:464154880090:web:bd2f540f76529d3ccc1063"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let myRole = '', roomId = '', state = { d: 50, idx: 0 };

    // ... (joinRoom ve startSync fonksiyonları aynı) ...

    function render(gameActive) {
        document.getElementById('icon-dr').style.left = state.d + "%";
        const area = document.getElementById('options-area');
        area.innerHTML = '';
        
        if (!gameActive) {
            document.getElementById('turn-info').innerText = ">> RAKİP SİNYALİ BEKLENİYOR...";
            document.getElementById('q-text').innerText = "KOD: " + roomId;
            return;
        }

        const task = tasks[state.idx % tasks.length];
        const isMyTurn = (myRole === 'hirsiz' && state.idx % 2 === 0) || (myRole === 'ajan' && state.idx % 2 !== 0);
        
        if (isMyTurn) {
            document.getElementById('turn-info').innerText = ">> SIRADAKİ HAMLE SENDE!";
            document.getElementById('q-text').innerText = task.q;
            task.opts.forEach((opt, i) => {
                const b = document.createElement('button');
                b.className = 'btn-win';
                b.innerText = opt;
                b.onclick = () => {
                    let newD = state.d;
                    if(myRole === 'hirsiz') newD += (i === task.ans ? 10 : -5);
                    else newD -= (i === task.ans ? 12 : -7);
                    
                    if(newD > 95) newD = 95;
                    if(newD < 5) newD = 5;

                    db.ref('rooms/' + roomId).update({ d: newD, idx: state.idx + 1 });
                };
                area.appendChild(b);
            });
        } else {
            document.getElementById('turn-info').innerText = ">> RAKİP ANALİZ EDİYOR...";
            document.getElementById('q-text').innerText = "Veri senkronizasyonu aktif...";
        }

        // BİTİŞ KONTROLÜ VE İSTATİSTİK TETİKLEME
        if(state.d >= 95) { 
            alert("DR. PARALEL KAÇTI!"); 
            recordWin('hirsiz'); 
        } else if(state.d <= 5) { 
            alert("AJAN ENKA YAKALADI!"); 
            recordWin('ajan'); 
        }
    }

    // YENİ İSTATİSTİK FONKSİYONU
    function recordWin(winner) {
        // Sadece bir tarafın (örneğin hırsızın) bu kaydı yapması yeterli (çift kayıt olmasın diye)
        if (myRole === 'hirsiz') {
            const statsRef = db.ref('global_stats');
            statsRef.transaction((currentData) => {
                if (currentData === null) {
                    return { total_games: 1, hirsiz_wins: (winner === 'hirsiz' ? 1 : 0), ajan_wins: (winner === 'ajan' ? 1 : 0) };
                } else {
                    currentData.total_games = (currentData.total_games || 0) + 1;
                    if (winner === 'hirsiz') currentData.hirsiz_wins = (currentData.hirsiz_wins || 0) + 1;
                    if (winner === 'ajan') currentData.ajan_wins = (currentData.ajan_wins || 0) + 1;
                    return currentData;
                }
            });
        }
        reset();
    }

    function reset() { 
        db.ref('rooms/' + roomId).remove(); 
        setTimeout(() => { location.reload(); }, 500); 
    }
</script>
